<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSL-KDD Security Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #1a1c23 0%, #2d3748 100%);
            color: #f7fafc; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        .card { 
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border: 1px solid #4a5568;
            border-radius: 15px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.5);
        }
        .card-header { 
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            border-bottom: 2px solid #63b3ed;
            font-weight: bold; 
            text-transform: uppercase; 
            letter-spacing: 1.5px;
            color: #e2e8f0;
            padding: 15px 20px;
            font-size: 0.95rem;
        }
        .text-success-custom { color: #48bb78; font-weight: 600; }
        .text-danger-custom { color: #f56565; font-weight: 600; }
        .text-warning-custom { color: #ed8936; font-weight: 600; }
        .stat-card { 
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border: 1px solid #4a5568;
        }
        .stat-card h3 { 
            font-size: 2.5rem; 
            font-weight: bold; 
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .stat-card p { 
            color: #cbd5e0; 
            margin: 0;
            font-weight: 500;
            font-size: 0.95rem;
        }
        .table-dark { 
            background-color: #2d3748; 
            --bs-table-bg: #2d3748; 
            color: #f7fafc; 
            border-color: #4a5568;
        }
        .table-dark thead th {
            background-color: #1a202c;
            color: #e2e8f0;
            font-weight: 600;
            border-color: #4a5568;
        }
        .table-dark tbody tr {
            border-color: #4a5568;
        }
        .table-dark tbody tr:hover {
            background-color: #374151;
        }
        .badge-attack { 
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            color: white; 
            padding: 6px 12px; 
            border-radius: 6px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(245,101,101,0.3);
        }
        .badge-normal { 
            background: linear-gradient(135deg, #48bb78 0%, #2f855a 100%);
            color: white; 
            padding: 6px 12px; 
            border-radius: 6px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(72,187,120,0.3);
        }
        .badge {
            font-size: 0.9rem;
        }
        h2, h3 {
            color: #f7fafc;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        small.text-muted {
            color: #cbd5e0 !important;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            border: none;
            box-shadow: 0 2px 4px rgba(66,153,225,0.3);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(66,153,225,0.4);
        }
    </style>
</head>
<body>

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold"><i class="fas fa-shield-alt text-primary"></i> Hệ Thống Phát Hiện Xâm Nhập (IDS)</h2>
            <small class="text-muted">Dữ liệu: NSL-KDD | Nền tảng: Apache Spark | Mô hình: LR & XGBoost</small>
        </div>
        <div>
            <span class="badge bg-success p-2"><i class="fas fa-check-circle"></i> Hệ thống Online</span>
            <button class="btn btn-sm btn-primary ms-2" onclick="loadResults()">
                <i class="fas fa-sync-alt"></i> Tải lại
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card p-3 stat-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <p>Tổng Gói Tin</p>
                        <h3 id="total-traffic">148,517</h3>
                    </div>
                    <i class="fas fa-network-wired fa-2x text-primary"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 stat-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <p>Phát Hiện Tấn Công</p>
                        <h3 id="attacks-detected" class="text-danger-custom">77,054</h3>
                    </div>
                    <i class="fas fa-bug fa-2x text-danger-custom"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 stat-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <p>Gói Tin Sạch</p>
                        <h3 id="normal-traffic" class="text-success-custom">70,853</h3>
                    </div>
                    <i class="fas fa-shield-virus fa-2x text-success-custom"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 stat-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <p>Mô Hình Tốt Nhất</p>
                        <h3 class="text-warning-custom">XGBoost</h3>
                    </div>
                    <i class="fas fa-trophy fa-2x text-warning-custom"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">So Sánh Hiệu Suất Mô Hình (Spark Output)</div>
                <div class="card-body">
                    <canvas id="modelComparisonChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Phân Phối Loại Tấn Công (Train Set)</div>
                <div class="card-body">
                    <canvas id="attackDistChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">Chi Tiết Kết Quả Đánh Giá (Evaluation Metrics)</div>
                <div class="card-body p-0">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Mô hình</th>
                                <th>Accuracy (Độ chính xác)</th>
                                <th>Precision</th>
                                <th>Recall</th>
                                <th>F1-Score</th>
                                <th>Area Under ROC (AUC)</th>
                            </tr>
                        </thead>
                        <tbody id="results-table">
                            <tr>
                                <td>Logistic Regression</td>
                                <td class="text-warning">95.18%</td>
                                <td>95.18%</td>
                                <td>95.18%</td>
                                <td>95.18%</td>
                                <td>0.9886</td>
                            </tr>
                            <tr style="border-left: 4px solid #f59e0b;">
                                <td class="fw-bold">XGBoost (Spark) <i class="fas fa-star text-warning"></i></td>
                                <td class="text-success-custom fw-bold">98.74%</td>
                                <td>98.74%</td>
                                <td>98.74%</td>
                                <td>98.74%</td>
                                <td class="fw-bold">0.9992</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-satellite-dish"></i> Giám Sát Gói Tin Thời Gian Thực (Mô phỏng từ Test Data)
                </div>
                <div class="card-body p-0">
                    <table class="table table-dark table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Source Bytes</th>
                                <th>Protocol</th>
                                <th>Service</th>
                                <th>Flag</th>
                                <th>Dự đoán (XGBoost)</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="live-traffic-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Biến global để lưu charts
    let comparisonChart, attackChart;
    
    // Load dữ liệu từ file JSON nếu có
    async function loadResults() {
        try {
            const response = await fetch('results.json?t=' + new Date().getTime());
            if (response.ok) {
                const data = await response.json();
                updateDashboard(data);
                console.log('✓ Đã load dữ liệu mới từ results.json');
            } else {
                console.log('⚠ Không tìm thấy results.json, sử dụng dữ liệu mặc định');
            }
        } catch (error) {
            console.log('⚠ Lỗi load results.json:', error);
        }
    }

    function updateDashboard(data) {
        if (data.statistics) {
            document.getElementById('total-traffic').textContent = data.statistics.total.toLocaleString();
            document.getElementById('attacks-detected').textContent = data.statistics.attacks.toLocaleString();
            document.getElementById('normal-traffic').textContent = data.statistics.normal.toLocaleString();
        }

        if (data.models && data.models.length > 0) {
            updateResultsTable(data.models);
            updateComparisonChart(data.models);
        }

        if (data.attack_distribution) {
            updateAttackChart(data.attack_distribution);
        }
    }

    function updateResultsTable(models) {
        const tbody = document.getElementById('results-table');
        tbody.innerHTML = '';
        
        models.forEach((model, index) => {
            const isBest = index === models.length - 1;
            const row = `
                <tr ${isBest ? 'style="border-left: 4px solid #f59e0b;"' : ''}>
                    <td class="${isBest ? 'fw-bold' : ''}">${model.name} ${isBest ? '<i class="fas fa-star text-warning"></i>' : ''}</td>
                    <td class="${isBest ? 'text-success-custom fw-bold' : 'text-warning'}">${(model.accuracy * 100).toFixed(2)}%</td>
                    <td>${(model.precision * 100).toFixed(2)}%</td>
                    <td>${(model.recall * 100).toFixed(2)}%</td>
                    <td>${(model.f1 * 100).toFixed(2)}%</td>
                    <td class="${isBest ? 'fw-bold' : ''}">${model.auc.toFixed(4)}</td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    // --- 1. Biểu đồ So sánh Mô hình ---
    const ctxComparison = document.getElementById('modelComparisonChart').getContext('2d');
    comparisonChart = new Chart(ctxComparison, {
        type: 'bar',
        data: {
            labels: ['Accuracy', 'Precision', 'Recall', 'F1-Score', 'AUC'],
            datasets: [
                {
                    label: 'Logistic Regression',
                    data: [0.9518, 0.9518, 0.9518, 0.9518, 0.9886],
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'XGBoost',
                    data: [0.9874, 0.9874, 0.9874, 0.9874, 0.9992],
                    backgroundColor: 'rgba(255, 159, 64, 0.7)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, max: 1.0, ticks: { color: 'white' } },
                x: { ticks: { color: 'white' } }
            },
            plugins: {
                legend: { labels: { color: 'white' } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + (context.parsed.y * 100).toFixed(2) + '%';
                        }
                    }
                }
            }
        }
    });

    function updateComparisonChart(models) {
        if (models.length >= 2) {
            comparisonChart.data.datasets[0].data = [
                models[0].accuracy, models[0].precision, models[0].recall, models[0].f1, models[0].auc
            ];
            comparisonChart.data.datasets[0].label = models[0].name;
            
            comparisonChart.data.datasets[1].data = [
                models[1].accuracy, models[1].precision, models[1].recall, models[1].f1, models[1].auc
            ];
            comparisonChart.data.datasets[1].label = models[1].name;
            
            comparisonChart.update();
        }
    }

    // --- 2. Biểu đồ Phân phối Tấn Công ---
    const ctxPie = document.getElementById('attackDistChart').getContext('2d');
    attackChart = new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: ['Normal', 'DoS', 'Probe', 'R2L', 'U2R'],
            datasets: [{
                data: [67343, 45927, 11656, 995, 52],
                backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'right', labels: { color: 'white' } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const value = context.parsed;
                            const percent = ((value / total) * 100).toFixed(1);
                            return context.label + ': ' + value.toLocaleString() + ' (' + percent + '%)';
                        }
                    }
                }
            }
        }
    });

    function updateAttackChart(distribution) {
        attackChart.data.labels = Object.keys(distribution);
        attackChart.data.datasets[0].data = Object.values(distribution);
        attackChart.update();
    }

    // --- 3. Script Giả lập Log Real-time ---
    const trafficTable = document.getElementById('live-traffic-body');
    const protocols = ['tcp', 'udp', 'icmp'];
    const services = ['http', 'private', 'ecr_i', 'smtp', 'ftp_data', 'domain_u', 'eco_i'];
    const flags = ['SF', 'S0', 'REJ', 'RSTO', 'SH'];
    const attackTypes = ['Neptune', 'Smurf', 'Satan', 'Portsweep', 'Normal'];

    function addRow() {
        const now = new Date().toLocaleTimeString();
        const isAttack = Math.random() > 0.52; // 48% attack rate theo NSL-KDD
        const protocol = protocols[Math.floor(Math.random() * protocols.length)];
        const service = services[Math.floor(Math.random() * services.length)];
        const flag = flags[Math.floor(Math.random() * flags.length)];
        const srcBytes = Math.floor(Math.random() * 5000);
        const attackType = isAttack ? attackTypes[Math.floor(Math.random() * (attackTypes.length - 1))] : 'Normal';
        
        const row = `
            <tr>
                <td>${now}</td>
                <td>${srcBytes}</td>
                <td><span class="badge bg-secondary">${protocol}</span></td>
                <td>${service}</td>
                <td>${flag}</td>
                <td class="fw-bold">${attackType}</td>
                <td>${isAttack ? '<span class="badge-attack">ALERT</span>' : '<span class="badge-normal">SAFE</span>'}</td>
            </tr>
        `;
        
        trafficTable.insertAdjacentHTML('afterbegin', row);
        if (trafficTable.children.length > 8) {
            trafficTable.removeChild(trafficTable.lastElementChild);
        }
    }

    // Khởi tạo
    loadResults();
    
    // Chạy giả lập mỗi 2 giây
    setInterval(addRow, 2000);
    addRow(); // Chạy ngay lần đầu
</script>

</body>
</html>